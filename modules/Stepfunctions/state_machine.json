{
  "Comment": "Video analysis step function",
  "StartAt": "CheckBucketContents",
  "States": {
    "CheckBucketContents": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:s3:listObjectsV2",
      "Parameters": {
        "Bucket.$": "$.input_bucket",
        "Prefix": "raw/",
        "MaxKeys": 1
      },
      "ResultPath": "$.s3ListResult",
      "Next": "Choice1"
    },
    "Choice1": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.input_key",
          "StringMatches": "*.mp4",
          "Next": "ECS RunTask LambdaSplitVideo"
        }
      ],
      "Default": "FailVideo"
    },
    "FailVideo": {
      "Type": "Fail",
      "Error": "NotVideoFormat",
      "Cause": "Only .mp4 allowed"
    },
    "ECS RunTask LambdaSplitVideo": {
      "Type": "Task",
      "Resource": "arn:aws:states:::ecs:runTask.sync",
      "Parameters": {
        "LaunchType": "FARGATE",
        "Cluster": "${ecs_cluster}",
        "TaskDefinition": "${video_splitter_arn}",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "Subnets.$": "States.Array($.fargateSUB)",
            "SecurityGroups.$": "States.Array($.fargateSG)",
            "AssignPublicIp": "ENABLED"
          }
        }
      },
      "Next": "CheckProcessingImages"
    },
    "CheckProcessingImages": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:s3:listObjectsV2",
      "Parameters": {
        "Bucket.$": "$.dump_bucket",
        "Prefix": "processing/"
      },
      "ResultPath": "$.processingResult",
      "Next": "Choice2"
    },
    "Choice2": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.processingResult.Contents",
          "IsPresent": true,
          "Next": "ECS RunTask CrashDetection"
        }
      ],
      "Default": "FailProcessing"
    },
    "FailProcessing": {
      "Type": "Fail",
      "Error": "NoProcessingImages",
      "Cause": "LambdaSplitVideo did not generate images"
    },
    "ECS RunTask CrashDetection": {
      "Type": "Task",
      "Resource": "arn:aws:states:::ecs:runTask",
      "Parameters": {
        "LaunchType": "FARGATE",
        "Cluster": "${ecs_cluster}",
        "TaskDefinition": "${image_processor_arn}",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "Subnets.$": "States.Array($.fargateSUB)",
            "SecurityGroups.$": "States.Array($.fargateSG)",
            "AssignPublicIp": "ENABLED"
          }
        }
      },
      "Next": "SaveResults"
    },
    "SaveResults": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:s3:putObject",
      "Parameters": {
        "Bucket.$": "$.dump_bucket",
        "Key": "results/detection.json",
        "Body.$": "$.Results"
      },
      "Next": "CheckResultsFiles"
    },
    "CheckResultsFiles": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:s3:listObjectsV2",
      "Parameters": {
        "Bucket.$": "$.dump_bucket",
        "Prefix": "results/"
      },
      "ResultPath": "$.resultsList",
      "Next": "Choice3"
    },
    "Choice3": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.resultsList.Contents",
          "IsPresent": true,
          "Next": "Lambda Invoke"
        }
      ],
      "Default": "FailResults"
    },
    "FailResults": {
      "Type": "Fail",
      "Error": "NoResultsFiles",
      "Cause": "Second stage did not generate results"
    },
    "Lambda Invoke": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "OutputPath": "$.Payload",
      "Parameters": {
        "FunctionName": "${Function1InvokeArns}",
        "Payload.$": "$"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException",
            "Lambda.TooManyRequestsException"
          ],
          "IntervalSeconds": 1,
          "MaxAttempts": 3,
          "BackoffRate": 2,
          "JitterStrategy": "FULL"
        }
      ],
      "Next": "Cleanup"
    },
    "Cleanup": {
      "Type": "Task",
      "Resource": "arn:aws:states:::aws-sdk:s3:deleteObject",
      "Parameters": {
        "Bucket.$": "$.dump_bucket",
        "Key": "processing/status.txt"
      },
      "End": true
    }
  }
}