{
  "Comment": "Video Analysis Workflow",
  "StartAt": "Run Fargate Task",
  "States": {
    "Run Fargate Task": {
      "Type": "Task",
      "Resource": "arn:aws:states:::ecs:runTask.sync",
      "Parameters": {
        "LaunchType": "FARGATE",
        "Cluster": "${EcsClusterName}",
        "TaskDefinition": "${TaskDefinitionFamily}",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "Subnets": ${Subnets},
            "SecurityGroups": ["${SecurityGroupId}"],
            "AssignPublicIp": "ENABLED"
          }
        },
        "Overrides": {
          "ContainerOverrides": [
            {
              "Name": "video-processor",
              "Environment": [
                {
                  "Name": "INPUT_S3_BUCKET",
                  "Value.$": "$.input_bucket"
                },
                {
                  "Name": "INPUT_S3_KEY",
                  "Value.$": "$.input_key"
                }
              ]
            }
          ]
        }
      },
      "Next": "Send Email via Lambda",
      "Catch": [
        {
          "ErrorEquals": [
            "States.ALL"
          ],
          "ResultPath": "$.error",
          "Next": "Fail State"
        }
      ]
    },
    "Send Email via Lambda": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:${Region}:${AccountId}:function:${LambdaFunctionName}",
        "Payload": {
          "video_key.$": "$.input_key",
          "bucket.$": "$.input_bucket",
          "details.$": "$"
        }
      },
      "Next": "Publish SNS"
    },
    "Publish SNS": {
      "Type": "Task",
      "Resource": "arn:aws:states:::sns:publish",
      "Parameters": {
        "TopicArn": "${SnsTopicArn}",
        "Message.$": "$"
      },
      "End": true
    },
    "Fail State": {
      "Type": "Fail",
      "Error": "FargateTaskFailed",
      "Cause": "Error running ECS Fargate Task"
    }
  }
}